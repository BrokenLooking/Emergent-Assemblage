<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emergent Assemblage</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      color: #00ffcc;
      font-family: monospace;
      height: 100%;
      width: 100%;
    }

    #quote {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      font-size: 1.6em;
      text-align: center;
      white-space: pre-line;
      z-index: 10;
    }

    #startOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.95);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      cursor: pointer;
      z-index: 1000;
    }

    audio {
      display: none;
    }
  </style>
</head>
<body>
  <div id="startOverlay">Click to activate the assemblage</div>
  <div id="quote">Initializing...</div>

  <audio id="background-audio" preload="auto" loop>
    <source src="emergenttrack2.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <script>
    const fragments = [
      "How does a gathering become a happening?",
      "Greater than the sum of its parts?",
      "One answer is contamination.",
      "Polyphony is music in which autonomous melodies intertwine.",
      "Poetics suggests life without what we think we need.",
      "Transformation through encounter.",
      "Letting go of control.",
      "Shifting hope toward action not born of desperation.",
      "Desire becomes design.",
      "You are always being made gently.",
      "You are always being unmade slowly.",
      "Technology is a traitorous saviour.",
      "The machine is dreaming.",
      "Tangled in signal.",
      "Data is growing teeth.",
      "Signal lost in velvet static.",
      "Uncertainty works in multiple ways."
    ];

    let weatherData = "üåç Weather unknown";
    let currentTemp = 20;
    let currentCondition = "clear";

    const apiKey = "78fc8980f87888c003d809ef3035c84c";

    function fetchWeather(lat, lon) {
      fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`)
        .then(res => res.json())
        .then(data => {
          currentTemp = data.main.temp;
          currentCondition = data.weather[0].main.toLowerCase();
          const desc = data.weather[0].description;
          weatherData = `üå¶Ô∏è ${currentTemp}¬∞C, ${desc}`;
          updateQuote();
        })
        .catch(err => {
          weatherData = "‚ö†Ô∏è Weather fetch error.";
          updateQuote();
        });
    }

    navigator.geolocation.getCurrentPosition(
      pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
      err => fetchWeather(50.8278, -0.1527) // Fallback: Brighton
    );

    function getEntangledQuote() {
      const shuffled = [...fragments].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, 3 + Math.floor(Math.random() * 3)).join(" ");
    }

    function speakQuote(text) {
      if ('speechSynthesis' in window) {
        const synth = window.speechSynthesis;

        function pickVoice() {
          const voices = synth.getVoices();
          if (!voices.length) {
            setTimeout(pickVoice, 100);
            return;
          }

          const preferred = voices.find(v =>
            v.name.includes("Google UK English Female") ||
            v.name.includes("Google US English") ||
            v.name.includes("Microsoft Aria") ||
            v.name.includes("Microsoft Eva") ||
            v.name.toLowerCase().includes("english")
          );

          const utter = new SpeechSynthesisUtterance(text);
          utter.voice = preferred || voices[0];
          utter.lang = 'en-US';
          utter.pitch = 1;
          utter.rate = 0.85;
          utter.volume = 0.6;
          synth.cancel();
          synth.speak(utter);
        }

        pickVoice();
      }
    }

    function updateQuote() {
      const quote = `${getEntangledQuote()}\n\n${weatherData}`;
      document.getElementById("quote").innerText = quote;
      speakQuote(quote.replace(/\n\n.*$/, ''));
    }

    setInterval(updateQuote, 10000);
    updateQuote();

    const audio = document.getElementById('background-audio');
    document.getElementById('startOverlay').addEventListener('click', () => {
      audio.play().then(() => {
        document.getElementById('startOverlay').style.display = 'none';
      }).catch(err => {
        alert("‚ö†Ô∏è Could not play audio. Check file.");
        console.error("Audio error:", err);
      });
    });

    // p5.js visuals
    let particles = [];
    function setup() {
      createCanvas(windowWidth, windowHeight);
      for (let i = 0; i < 150; i++) {
        particles.push({
          x: random(width),
          y: random(height),
          vx: random(-0.5, 0.5),
          vy: random(-0.5, 0.5),
          size: random(1, 4)
        });
      }
    }

    function draw() {
      background(0, 10);
      noStroke();
      fill(0, 255, 204, 100);
      for (let p of particles) {
        ellipse(p.x, p.y, p.size);
        p.x += p.vx;
        p.y += p.vy;
        if (p.x < 0 || p.x > width) p.vx *= -1;
        if (p.y < 0 || p.y > height) p.vy *= -1;
      }

      if (audio && !audio.paused) {
        let speed = map(mouseX, 0, width, 0.5, 2.0);
        audio.playbackRate = constrain(speed, 0.5, 2.0);
      }

      renderWeatherVisuals();
    }

    function renderWeatherVisuals() {
      let tHue = map(currentTemp, -10, 40, 200, 0);
      noStroke();
      fill(tHue, 255, 150, 20);
      ellipse(width / 2, height / 2, map(currentTemp, -10, 40, 100, 400));

      if (currentCondition.includes("rain")) {
        for (let i = 0; i < 50; i++) {
          stroke(0, 150, 255, 100);
          line(random(width), random(height), random(width), random(height + 10));
        }
      }

      if (currentCondition.includes("clear")) {
        fill(255, 255, 0, 10);
        ellipse(width / 2, height / 2, 50);
      }

      if (currentCondition.includes("snow")) {
        fill(255, 255, 255, 80);
        for (let i = 0; i < 30; i++) {
          ellipse(random(width), random(height), 2);
        }
      }

      if (currentCondition.includes("cloud")) {
        fill(200, 200, 200, 20);
        ellipse(width / 2 + random(-100, 100), height / 2 + random(-100, 100), 100);
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
